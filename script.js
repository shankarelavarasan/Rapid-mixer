// script.js

// File Input Element-роХрпНроХро╛рой Event Listener
// 'zipInput' роОройрпНрокродро▒рпНроХрпБ рокродро┐ро▓ро╛роХ 'folderInput' роОройрпНро▒рпБ рооро╛ро▒рпНро▒рокрпНрокроЯрпНроЯрпБро│рпНро│родрпБ
document.getElementById('folderInput').addEventListener('change', function (e) {
  const files = e.target.files;
  let allText = '';
  let txtCount = 0;

  // родрпЗро░рпНроирпНродрпЖроЯрпБроХрпНроХрокрпНрокроЯрпНроЯ роХрпЛрокрпНрокрпБроХро│рпИ Process роЪрпЖропрпНродро▓рпН
  const readerPromises = Array.from(files).map(file => {
    // .txt роХрпЛрокрпНрокрпБроХро│рпИ роороЯрпНроЯрпБроорпН Filter роЪрпЖропрпНропро╡рпБроорпН, роЗродрпБ роТро░рпБ роХрпЛрокрпНрокрпБро▒рпИ роЙро│рпНро│рпЗ роЗро░рпБроХрпНроХрпБроорпН роХрпЛрокрпНрокрпБроХро│рпБроХрпНроХрпБроорпН рокрпКро░рпБроирпНродрпБроорпН
    if (!file.type && file.name.endsWith('.txt')) { // !file.type роОройрпНрокродрпБ File-роР ро╡ро┐роЯ Folder-роР роЕроЯрпИропро╛ро│роорпН роХро╛рог роЙродро╡рпБроорпН, роЖройро╛ро▓рпН webkitdirectory-ро▓рпН родрпЗро░рпНроирпНродрпЖроЯрпБроХрпНроХрокрпНрокроЯрпБроорпН роХрпЛрокрпНрокрпБроХро│рпБроХрпНроХрпБ роЗродрпБ роЪро░ро┐ропро╛роХ ро╡рпЗро▓рпИ роЪрпЖропрпНропро╛родрпБ. рокрпКродрпБро╡ро╛роХ ро╡рпЖро▒рпБроорпН file.name.endsWith('.txt') рокрпЛродрпБрооро╛ройродрпБ.
       // роТро░рпБ роХрпЛрокрпНрокрпБро▒рпИропро┐ро▓рпН роЙро│рпНро│ роХрпЛрокрпНрокрпБроХро│рпИ роХрпИропро╛ро│рпБроорпНрокрпЛродрпБ, роХрпЛрокрпНрокрпБ рокро╛родрпИропрпИ (subfolders) роХро╡ройрооро╛роХ роХрпИропро╛ро│ ро╡рпЗрогрпНроЯрпБроорпН
       // роЗроЩрпНроХрпБ роХрпЛрокрпНрокрпБ рокрпЖропро░рпН роороЯрпНроЯрпБроорпЗ рокропройрпНрокроЯрпБродрпНродрокрпНрокроЯрпБроХро┐ро▒родрпБ, роЗродрпБ рокрпКродрпБро╡ро╛роХ роОро│ро┐роорпИропро╛рой рокропройрпНрокро╛роЯрпНроЯро┐ро▒рпНроХрпБ роЪро░ро┐.
      txtCount++;
      // роХрпЛрокрпНрокро┐ройрпН роЙро│рпНро│роЯроХрпНроХродрпНродрпИрокрпН рокроЯро┐роХрпНроХро╡рпБроорпН
      return file.text().then(content => {
        // роОро▓рпНро▓ро╛ .txt роХрпЛрокрпНрокрпБроХро│ро┐ройрпН роЙро│рпНро│роЯроХрпНроХродрпНродрпИропрпБроорпН роЪрпЗро░рпНродрпНродрпБроХрпНроХрпКро│рпНро│ро╡рпБроорпН, роТро╡рпНро╡рпКро░рпБ роХрпЛрокрпНрокро┐ро▒рпНроХрпБроорпН роТро░рпБ рокро┐ро░ро┐рокрпНрокро╛ройрпН роЪрпЗро░рпНроХрпНроХро╡рпБроорпН
        allText += `\n\n--- ${file.name} ---\n${content}`;
      }).catch(error => {
          console.error(`Error reading file ${file.name}:`, error);
          // роХрпЛрокрпНрокрпБ рокроЯро┐роХрпНроХродрпН родро╡ро▒ро┐ройро╛ро▓рпН, роЕродрпИрокрпН рокро▒рпНро▒ро┐ роХрпБро▒ро┐роХрпНроХро▓ро╛роорпН
          allText += `\n\n--- ${file.name} (Error Reading) ---\n`;
      });
    }
    return Promise.resolve(); // .txt роЕро▓рпНро▓ро╛род роХрпЛрокрпНрокрпБроХро│рпИ рокрпБро▒роХрпНроХрогро┐роХрпНроХро╡рпБроорпН
  });

  // роОро▓рпНро▓ро╛ роХрпЛрокрпНрокрпБроХро│рпИропрпБроорпН рокроЯро┐родрпНродрпБ роорпБроЯро┐родрпНрод рокро┐ро▒роХрпБ
  Promise.all(readerPromises).then(() => {
      // Promise.all rejected роЖроХро╛рооро▓рпН роЗро░рпБрокрпНрокродро▒рпНроХрпБ catch-роР Promise-роХрпНроХрпБро│рпН роЪрпЗро░рпНродрпНродрпБро│рпНро│рпЛроорпН, роЗроЩрпНроХрпБ errors роЗро░рпБроирпНродро╛ро▓рпБроорпН proceed роЖроХрпБроорпН.
      // роХро╛роЯрпНроЯрокрпНрокроЯрпБроорпН Text-роР Update роЪрпЖропрпНропро╡рпБроорпН
    document.getElementById("responseArea").textContent = `ЁЯУД ${txtCount} .txt files loaded.\nReady to run Gemini.\n\nExtracted Text:\n${allText}`;
     // allText-роР роТро░рпБ роХрпБро│рпЛрокро▓рпН рооро╛ро▒ро┐ роЕро▓рпНро▓родрпБ ро╡рпЗро▒рпБ ро╡ро┤ро┐ропро┐ро▓рпН Analyze рокроЯрпНроЯройрпН роХро┐ро│ро┐роХрпН роЪрпЖропрпНропрпБроорпН рокрпЛродрпБ рокропройрпНрокроЯрпБродрпНрод роЪрпЗрооро┐роХрпНроХ ро╡рпЗрогрпНроЯрпБроорпН.
     // родро▒рпНрокрпЛродрпИроп code-ро▓рпН роЗродрпБ responseArea-ро╡ро┐ро▓рпН роЪрпЗро░рпНроХрпНроХрокрпНрокроЯрпБроХро┐ро▒родрпБ, роЗродрпБ роЪро░ро┐ропро╛роХ роЗро░рпБроХрпНроХро▓ро╛роорпН роЕро▓рпНро▓родрпБ роЗро▓рпНро▓ро╛рооро▓рпН рокрпЛроХро▓ро╛роорпН, роЙроЩрпНроХро│рпН родрпЗро╡рпИропрпИрокрпН рокрпКро▒рпБродрпНродродрпБ.
     // роТро░рпБ родройро┐ рооро╛ро▒ро┐ рокропройрпНрокроЯрпБродрпНродрпБро╡родрпБ рокрпКродрпБро╡ро╛роХ роЪро┐ро▒роирпНрод ро╡ро┤ро┐. роЙродро╛ро░рогрооро╛роХ: window.loadedFilesText = allText;
  }).catch(error => {
      console.error("Error processing files:", error);
      document.getElementById("responseArea").textContent = "тЭМ Error loading files.";
  });
});


// Analyze рокроЯрпНроЯройрпБроХрпНроХро╛рой Event Listener
document.getElementById("analyzeBtn").addEventListener("click", async () => {
  const userPrompt = document.getElementById('promptInput').value;
  // responseArea-ро╡ро┐ро▓рпН роЗро░рпБроирпНродрпБ data роОроЯрпБрокрпНрокродрпБ роЙроЩрпНроХро│рпБроХрпНроХрпБродрпН родрпЗро╡рпИропро╛ роЕро▓рпНро▓родрпБ роорпБройрпНройро░рпН роЪрпЗрооро┐родрпНрод allText родрпЗро╡рпИропро╛ роОройрпНрокродрпИ роЙро▒рпБродро┐рокрпНрокроЯрпБродрпНродро╡рпБроорпН
  // родро▒рпНрокрпЛродрпИроп code responseArea-ро╡ро┐ро▓рпН роЗро░рпБроирпНродрпБ роОроЯрпБроХрпНроХро┐ро▒родрпБ
  const loadedContent = document.getElementById("responseArea").textContent; // роЗродрпБ роЗрокрпНрокрпЛродрпБ file content + count text-роР роХрпКрогрпНроЯро┐ро░рпБроХрпНроХрпБроорпН

  // File Load роЪрпЖропрпНропрокрпНрокроЯрпНроЯрпБро│рпНро│родро╛ роОрой роТро░рпБ роОро│ро┐роп роЪрпЛродройрпИ
  // роЗроирпНрод роЪрпЛродройрпИ роЪро░ро┐ропро╛роХ ро╡рпЗро▓рпИ роЪрпЖропрпНропрпБрооро╛ роОройрпНрокродрпБ responseArea text format-роРрокрпН рокрпКро▒рпБродрпНродродрпБ
  // роирпАроЩрпНроХро│рпН родройро┐ рооро╛ро▒ро┐ропро┐ро▓рпН allText роЪрпЗрооро┐родрпНродро┐ро░рпБроирпНродро╛ро▓рпН, роЕродрпИроЪрпН роЪрпЛродро┐рокрпНрокродрпБ роиро▓рпНро▓родрпБ
  if (!loadedContent.includes("Extracted Text:")) { // Text Format-роР рокрпКро▒рпБродрпНродрпБ роЗроирпНрод роЪрпЛродройрпИ рооро╛ро▒рпНро▒рокрпНрокроЯ ро╡рпЗрогрпНроЯрпБроорпН
    alert("ЁЯУВ Please select a folder with .txt files first!");
    return;
  }

  // Prompt-роР роХрпЛрокрпНрокрпБ роЙро│рпНро│роЯроХрпНроХродрпНродрпБроЯройрпН роЪрпЗро░рпНроХрпНроХро╡рпБроорпН
  // loadedContent-ро▓рпН count рооро▒рпНро▒рпБроорпН рооро▒рпНро▒ text роЗро░рпБрокрпНрокродро╛ро▓рпН, роЪро░ро┐ропро╛рой file content рокро┐ро░ро┐родрпНродрпЖроЯрпБроХрпНроХ ро╡рпЗрогрпНроЯрпБроорпН роЕро▓рпНро▓родрпБ родройро┐ропро╛роХ роЪрпЗрооро┐родрпНрод allText-роР рокропройрпНрокроЯрпБродрпНрод ро╡рпЗрогрпНроЯрпБроорпН.
  // родро▒рпНрокрпЛродрпИроп code responseArea роорпБро┤рпБро╡родрпБроорпН роЕройрпБрокрпНрокрпБроХро┐ро▒родрпБ, роЗродрпБ Gemini-роХрпНроХрпБ родрпЗро╡рпИ роЗро▓рпНро▓ро╛род родроХро╡ро▓рпИ роЕройрпБрокрпНрокро▓ро╛роорпН.
  // роЙроЩрпНроХро│рпН Backend роОродро┐ро░рпНрокро╛ро░рпНрокрпНрокрпИрокрпН рокрпКро▒рпБродрпНродрпБ роЗродрпИ роЪро░ро┐ роЪрпЖропрпНроп ро╡рпЗрогрпНроЯрпБроорпН.
  // роЙродро╛ро░рогрооро╛роХ, роирпАроЩрпНроХро│рпН window.loadedFilesText = allText; роОройрпНро▒рпБ роорпЗро▓рпЗ роЪрпЗрооро┐родрпНродро┐ро░рпБроирпНродро╛ро▓рпН:
  // const fullPrompt = userPrompt + '\n\n' + window.loadedFilesText;
  const fullPrompt = userPrompt + '\n\n' + loadedContent; // родро▒рпНрокрпЛродрпИроп Code-ройрпНрокроЯро┐


  document.getElementById("responseArea").textContent = "тМЫ Sending prompt to Gemini..."; // Loading роиро┐ро▓рпИ роХро╛роЯрпНроЯрпБродро▓рпН

  try {
    // Backend API-роХрпНроХрпБ Request роЕройрпБрокрпНрокрпБродро▓рпН
    // роЙроЩрпНроХро│рпН Glitch URL: https://plaid-occipital-noise.glitch.me
    const response = await fetch("https://plaid-occipital-noise.glitch.me/ask-gemini", {
      method: "POST", // POST method
      headers: { "Content-Type": "application/json" }, // JSON format-ро▓рпН data роЕройрпБрокрпНрокрпБродро▓рпН
      body: JSON.stringify({ prompt: fullPrompt }) // Prompt data-ро╡рпИ JSON роЖроХ рооро╛ро▒рпНро▒рпБродро▓рпН
    });

    // Response successful роЖроХ роЗро░рпБроирпНродродро╛ роОройроЪрпН роЪро░ро┐рокро╛ро░рпНродрпНродро▓рпН (Status Code 200-299)
    if (!response.ok) {
        const errorText = await response.text(); // Backend-ро▓ро┐ро░рпБроирпНродрпБ ро╡роирпНрод Error Text
        throw new Error(`HTTP error! status: ${response.status}\n${errorText}`);
    }

    // Response-ро▓рпН роЗро░рпБроирпНродрпБ Result-роРрокрпН рокрпЖро▒рпБродро▓рпН
    const result = await response.text(); // Backend plain text роЕройрпБрокрпНрокрпБро╡родро╛роХ роЕройрпБрооро╛ройроорпН

    // Result-роР Webpage-ро▓рпН роХро╛роЯрпНроЯрпБродро▓рпН
    document.getElementById("responseArea").textContent = result;

  } catch (error) {
    // API роЕро┤рпИрокрпНрокро┐ро▓рпН рокро┐ро┤рпИ роПро▒рпНрокроЯрпНроЯро╛ро▓рпН
    console.error("Gemini API call failed:", error);
    document.getElementById("responseArea").textContent = "тЭМ Gemini API call failed.\n" + error.message; // Error message-роР роХро╛роЯрпНроЯро╡рпБроорпН
  }
});
